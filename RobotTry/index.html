<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Robot v4.0 â€” Responsive Interface</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide-dev@0.395.0"></script>

    <script>
      // Configuration for Tailwind CSS
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              accent: {
                DEFAULT: 'var(--accent)',
                light: 'var(--accent-light)',
              },
            },
          },
        },
      };
    </script>

    <style>
      /* --- CORE STYLES (UNCHANGED) --- */
      :root {
        --shell: #edf3f9; --line: #4f5b76; --face: #0f1b2e;
        --eye: #72f1d5; --accent: #28d9c9; --accent-light: #66e5c4;
        --glow: 0.6; --robot-scale: 1;
      }
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
      
      /* Robot Draggability & Focus */
      .robot-wrap {
        touch-action: none; cursor: grab;
        border-radius: 50%; outline: none;
      }
      .robot-wrap:focus-visible {
        box-shadow: 0 0 0 4px #1e293b, 0 0 0 8px #60a5fa;
      }
      .robot-wrap.dragging { cursor: grabbing; }

      /* --- CORE ROBOT ANIMATIONS (UNCHANGED LOGIC) --- */
      @keyframes hover { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
      .robot.is-hovering { animation: hover 5s ease-in-out infinite; }
      @keyframes nod { 0%, 100% { transform: rotate(0deg); } 40% { transform: rotate(3deg); } 60% { transform: rotate(-2deg); } }
      .robot.is-nodding .head { animation: nod 2.2s ease-in-out infinite both; }
      @keyframes tiltShort { 0% { transform: rotate(0); } 30% { transform: rotate(-6deg); } 60% { transform: rotate(5deg); } 100% { transform: rotate(0); } }
      .robot.is-tilting .head { animation: tiltShort 600ms ease-in-out; }
      @keyframes earL { 0%, 100% { transform: rotate(0); } 50% { transform: rotate(-8deg); } }
      @keyframes earR { 0%, 100% { transform: rotate(0); } 50% { transform: rotate(8deg); } }
      .robot.is-wiggling .ear.left { animation: earL 1.6s ease-in-out infinite; }
      .robot.is-wiggling .ear.right { animation: earR 1.6s ease-in-out infinite; }
      @keyframes ping { 0% { transform: translateX(-50%) scale(1); opacity: 1; } 100% { transform: translateX(-50%) scale(1.6); opacity: 0; } }
      .antenna::before { content: ""; position: absolute; top: -14px; left: 50%; width: 18px; height: 18px; border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 0 0 rgba(114, 241, 213, 0.7); animation: ping 1.8s ease-out infinite; }
      @keyframes blinkOnce { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.1); } }
      .eye.is-blinking { animation: blinkOnce 160ms linear; }
      @keyframes speak { 0%, 100% { transform: scaleY(0.6); } 20% { transform: scaleY(1.0); } 40% { transform: scaleY(0.4); } 60% { transform: scaleY(0.9); } 80% { transform: scaleY(0.5); } }
      .robot.is-speaking .mouth-visual { animation: speak 700ms ease-in-out infinite; }
      @keyframes charge { to { stroke-dashoffset: 0; } }
      .torso-wrap.is-charging #batteryFill { stroke-dasharray: 240; stroke-dashoffset: 240; animation: charge 2.2s ease-in-out forwards; filter: drop-shadow(0 0 6px var(--eye)); }
      @media (prefers-reduced-motion: reduce) { .robot, .head, .ear, .antenna, .mouth-visual, #batteryFill { animation: none !important; } }
      
      /* --- ROBOT STRUCTURE (UNCHANGED) --- */
      .head { width: 240px; height: 189.6px; border-radius: 52%/40%; background: var(--shell); border: 2.5px solid var(--line); transform-origin: 50% 100%; }
      .ear { width: 20px; height: 40px; border-radius: 10px; background: var(--shell); border: 2.5px solid var(--line); transform-origin: 50% 10%; }
      .ear.left { left: -22px; } .ear.right { right: -22px; }
      .antenna { width: 12px; height: 28px; background: var(--line); border-radius: 6px; }
      .antenna::after { content: ""; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 18px; height: 18px; border-radius: 50%; background: var(--eye); box-shadow: 0 0 10px var(--eye); }
      .face { width: 87%; height: 86%; background: var(--face); border-radius: 42%/36%; border: 2px solid #5c6986; }
      .eye { width: 35px; height: 35px; background: var(--eye); box-shadow: 0 0 calc(12px * var(--glow)) var(--eye); }
      .pupil { width: 14px; height: 14px; background: #0b1626; }
      .highlight { width: 7px; height: 7px; background: #fff; }
      .mouth { width: 48px; height: 26px; display: flex; align-items: flex-end; }
      .mouth-visual { width: 100%; height: 100%; transform-origin: bottom; border-radius: 0 0 40px 40px; background: var(--accent); box-shadow: inset 0 -4px 6px rgba(0, 0, 0, 0.25), 0 0 calc(8px * var(--glow)) var(--eye); }
      .neck { width: 74px; height: 20px; background: var(--shell); border: 2.5px solid var(--line); border-top: none; border-radius: 0 0 80px 80px; margin-top: -5px; }
      .torso-wrap { width: 260px; height: 270px; margin-top: -71px; }
      .wing { fill: var(--shell); stroke: var(--line); stroke-width: 3; stroke-linejoin: round; }

      /* Modal styles */
      dialog { color: #d1d5db; }
      dialog::backdrop { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
    </style>
  </head>

  <body class="bg-slate-900 text-slate-300 font-sans overflow-hidden h-screen w-screen">
    <div id="app" class="h-full w-full relative lg:flex">

      <!-- Control Panel (Sidebar on Desktop, Drawer on Mobile) -->
      <aside id="controls" class="fixed inset-y-0 left-0 w-80 max-w-[90vw] bg-slate-950/80 backdrop-blur-lg border-r border-slate-800 flex flex-col p-4 transition-transform duration-300 ease-in-out z-40 -translate-x-full lg:relative lg:translate-x-0 lg:flex-shrink-0">
        <div class="flex-shrink-0 flex items-center justify-between pb-3 border-b border-slate-800">
            <h1 class="text-xl font-bold text-slate-100">Robot Controls</h1>
            <button data-action="feedback" class="p-2 rounded-md hover:bg-slate-700 transition-colors" aria-label="Open Feedback Form">
                <i data-lucide="message-square-plus" class="w-5 h-5 text-slate-400"></i>
            </button>
        </div>
        
        <div class="flex-grow overflow-y-auto custom-scrollbar -mr-2 pr-2 mt-4 space-y-6">
            <!-- Sections for controls -->
            <div class="space-y-4">
                <h2 class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">Display</h2>
                <div>
                    <label for="scaleRange" class="text-sm font-medium text-slate-400 block mb-2">Scale</label>
                    <div class="flex items-center gap-3">
                      <i data-lucide="zoom-out" class="w-5 h-5 text-slate-500"></i>
                      <input type="range" id="scaleRange" min="0.4" max="2" step="0.05" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-400" />
                      <i data-lucide="zoom-in" class="w-5 h-5 text-slate-500"></i>
                    </div>
                </div>
                <button data-action="theme" class="btn w-full"><i data-lucide="palette"></i><span>Next Theme</span></button>
            </div>
            <div class="space-y-3">
                <h2 class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">Actions</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button data-action="toggle-speak" class="btn"><i data-lucide="message-circle"></i><span>Speak</span></button>
                    <button data-action="blink" class="btn"><i data-lucide="eye"></i><span>Blink</span></button>
                    <button data-action="toggle-nod" class="btn"><i data-lucide="arrow-down-up"></i><span>Nod</span></button>
                    <button data-action="tilt" class="btn"><i data-lucide="rotate-ccw"></i><span>Tilt Head</span></button>
                    <button data-action="toggle-ears" class="btn"><i data-lucide="move-horizontal"></i><span>Wiggle Ears</span></button>
                    <button data-action="charge" class="btn"><i data-lucide="battery-charging"></i><span>Charge</span></button>
                    <button data-action="toggle-hover" class="btn is-active"><i data-lucide="chevrons-up-down"></i><span>Hover</span></button>
                    <button data-action="armReset" class="btn"><i data-lucide="rotate-cw"></i><span>Reset Arms</span></button>
                </div>
            </div>
            <div class="space-y-3">
                <h2 class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">Arms (Robot's Perspective)</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button data-action="toggle-waveLeft" class="btn"><i data-lucide="hand"></i><span>Wave Left</span></button>
                    <button data-action="toggle-waveRight" class="btn"><i data-lucide="hand"></i><span>Wave Right</span></button>
                    <button data-action="toggle-float" class="btn"><i data-lucide="waves"></i><span>Float</span></button>
                    <button data-action="flare" class="btn"><i data-lucide="sun"></i><span>Flare</span></button>
                </div>
            </div>
            <div class="space-y-3">
                <h2 class="text-sm font-semibold text-cyan-300 uppercase tracking-wider">Story Macros</h2>
                <div class="grid grid-cols-1 gap-2">
                    <button data-action="storyGreet" class="btn-story">ðŸ‘‹ Greet</button>
                    <button data-action="storyShy" class="btn-story">ðŸ˜Š Shy</button>
                    <button data-action="storyPresent" class="btn-story">âœ¨ Present</button>
                    <button data-action="storyThink" class="btn-story">ðŸ¤” Think</button>
                    <button data-action="storyCelebrate" class="btn-story">ðŸŽ‰ Celebrate</button>
                </div>
            </div>
        </div>
        <div class="flex-shrink-0 pt-3 border-t border-slate-800">
            <button data-action="resetAll" class="btn w-full bg-rose-600/20 text-rose-300 hover:bg-rose-600/40 border border-rose-500/30">
                <i data-lucide="power-off"></i><span>Reset All</span>
            </button>
        </div>
      </aside>

      <!-- Mobile Panel Toggle & Overlay -->
      <div id="panel-overlay" class="fixed inset-0 bg-slate-950/50 z-30 transition-opacity opacity-0 pointer-events-none lg:hidden"></div>
      <button id="panelToggle" class="fixed top-4 left-4 z-50 p-2 bg-slate-950/70 backdrop-blur-lg border border-slate-800 rounded-lg hover:bg-slate-700 transition-colors lg:hidden" aria-label="Toggle Controls Panel">
        <i data-lucide="panel-left"></i>
      </button>

      <!-- Main Stage -->
      <main id="stage" class="relative w-full h-full flex-grow">
        <div class="absolute inset-0 bg-gradient-radial from-slate-800 via-slate-900 to-slate-950"></div>
        <div class="absolute inset-0 bg-[radial-gradient(#ffffff15_1px,transparent_1px)] [background-size:16px_16px] opacity-30"></div>

        <div id="robotWrap" tabindex="0" class="robot-wrap absolute left-1/2 top-1/2 p-4 -m-4" style="transform: translate(-50%, -50%) scale(var(--robot-scale));">
          <div id="robot" class="robot relative flex flex-col items-center is-hovering">
            <!-- Robot SVG structure -->
            <div id="head" class="head relative flex justify-center items-center z-10">
              <div class="antenna absolute top-[-28px] left-1/2 transform -translate-x-1/2 z-0"></div>
              <div class="ear left absolute top-[36%] z-[-1]"></div><div class="ear right absolute top-[36%] z-[-1]"></div>
              <div class="face relative flex flex-col items-center justify-center overflow-hidden">
                <div class="eyes flex gap-[38px] items-center justify-center mb-3">
                  <div id="eyeL" class="eye relative rounded-full overflow-hidden"><div class="pupil absolute left-1/2 top-1/2 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div><div class="highlight absolute left-[28%] top-[28%] rounded-full opacity-90"></div></div>
                  <div id="eyeR" class="eye relative rounded-full overflow-hidden"><div class="pupil absolute left-1/2 top-1/2 rounded-full transform -translate-x-1/2 -translate-y-1/2"></div><div class="highlight absolute left-[28%] top-[28%] rounded-full opacity-90"></div></div>
                </div>
                <div class="mouth"><div class="mouth-visual"></div></div>
              </div>
            </div>
            <div class="neck relative z-0"></div>
            <div class="torso-wrap relative z-[-1]">
              <svg id="torsoSVG" viewBox="0 0 260 270" class="overflow-visible">
                <defs>
                  <linearGradient id="panelGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#ffffff" stop-opacity=".45" /><stop offset="100%" stop-color="#000000" stop-opacity=".06" /></linearGradient>
                  <linearGradient id="batteryGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop id="batteryGradStop1" offset="0%" stop-color="#0ad9c9" /><stop id="batteryGradStop2" offset="100%" stop-color="#66e5c4" /></linearGradient>
                  <path id="torsoPath" d="M40 72 Q130 40 220 72 Q225 140 208 210 Q130 260 52 210 Q35 140 40 72 Z" />
                  <clipPath id="clipTorso"><use href="#torsoPath" /></clipPath>
                </defs>
                <use href="#torsoPath" fill="var(--shell)" stroke="var(--line)" stroke-width="3" />
                <!-- NOTE: The IDs armLeft/Right correspond to the ROBOT's left/right -->
                <g id="armLeft"><path id="wingLeft" class="wing" /></g>
                <g id="armRight"><path id="wingRight" class="wing" /></g>
                <g clip-path="url(#clipTorso)">
                  <rect x="0" y="0" width="260" height="270" fill="url(#panelGrad)" opacity=".55" />
                  <path d="M60 130 Q130 116 200 130" stroke="#c9d3e2" stroke-width="8" opacity=".45" /><path d="M66 164 Q130 158 194 164" stroke="#d7dee9" stroke-width="6" opacity=".5" /><path d="M74 198 Q130 216 186 198" stroke="#d7dee9" stroke-width="10" opacity=".6" />
                </g>
                <path d="M60 110 Q130 100 200 110" fill="none" stroke="rgba(100,110,140,.28)" stroke-width="12" stroke-linecap="round" /><path id="batteryFill" d="M60 110 Q130 100 200 110" fill="none" stroke="url(#batteryGrad)" stroke-width="12" stroke-linecap="round" />
              </svg>
            </div>
          </div>
        </div>
      </main>

      <!-- Feedback Modal -->
      <dialog id="feedbackDialog" class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-xl p-6">
        <form method="dialog" class="space-y-4">
            <div class="flex items-center justify-between"><h2 class="text-lg font-bold text-cyan-300">Feedback & Notes</h2><button value="cancel" class="p-1 rounded-md hover:bg-slate-700 transition-colors"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button></div>
            <input type="text" id="fbTitle" placeholder="Feedback Title..." class="fb-input">
            <textarea id="fbGeneral" placeholder="General feedback..." class="fb-input" rows="4"></textarea>
            <div class="flex gap-3"><button id="fbCopy" class="btn flex-1"><i data-lucide="copy"></i><span>Copy JSON</span></button><button id="fbClear" type="button" class="btn flex-1"><i data-lucide="trash-2"></i><span>Clear</span></button></div>
            <p id="fbStatus" class="text-xs text-slate-500 h-4 text-center"></p>
        </form>
      </dialog>
    </div>

    <script>
    class RobotController {
        constructor() {
            // State, themes, and geometry are unchanged
            this.state = { isBusy: false, isDragging: false, currentTheme: 0, dragStart: { x: 0, y: 0 }, robotPos: { x: 0, y: 0 }, wave: { left: false, right: false, start: 0, amp: 6, period: 1200 }, flare: { active: false, base: 0, peak: 0, start: 0, dur: 600 }, float: { active: false, base: 75, amp: 4, period: 1800, start: 0 }, rafId: null };
            this.themes = [ { shell: "#edf3f9", line: "#4f5b76", face: "#0f1b2e", eye: "#72f1d5", accent: "#28d9c9", accentLight: "#66e5c4" }, { shell: "#fff3ea", line: "#7a4b3d", face: "#2a1a20", eye: "#ffd166", accent: "#ef476f", accentLight: "#f2829c" }, { shell: "#ecfff6", line: "#437c6b", face: "#0e2220", eye: "#8cf8c7", accent: "#22c55e", accentLight: "#74f686" }, { shell: "#f4f6f8", line: "#2f3747", face: "#0e1116", eye: "#a5b4fc", accent: "#60a5fa", accentLight: "#8eacf7" } ];
            this.geometry = { size: { len: 134, bulge: 53, tip: 22, innerCurve: 6 }, align: { anchorY: 75, inset: -9 } };
            
            this.cacheDOMElements();
            this.bindEvents();
            this.init();
        }

        cacheDOMElements() {
            this.els = {
                robotWrap: document.getElementById('robotWrap'),
                robot: document.getElementById('robot'),
                eyes: [document.getElementById('eyeL'), document.getElementById('eyeR')],
                pupils: document.querySelectorAll('.pupil'),
                torsoWrap: document.querySelector('.torso-wrap'),
                batteryGradStops: [document.getElementById('batteryGradStop1'), document.getElementById('batteryGradStop2')],
                scaleRange: document.getElementById('scaleRange'),
                actionButtons: document.querySelectorAll('[data-action]'),
                feedbackDialog: document.getElementById('feedbackDialog'),
                feedback: { title: document.getElementById('fbTitle'), general: document.getElementById('fbGeneral'), copy: document.getElementById('fbCopy'), clear: document.getElementById('fbClear'), status: document.getElementById('fbStatus') },
                svg: { wingLeft: document.getElementById('wingLeft'), wingRight: document.getElementById('wingRight') },
                panel: { controls: document.getElementById('controls'), toggle: document.getElementById('panelToggle'), overlay: document.getElementById('panel-overlay') }
            };
        }

        init() {
            this.centerRobot();
            this.applyTheme(this.themes[this.state.currentTheme]);
            this.drawArms();
            this.startBlinkLoop();
            
            // Apply shared styles dynamically
            document.querySelectorAll('.btn').forEach(el => el.className = 'btn text-sm bg-slate-700/80 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed border border-slate-700 rounded-md py-2 px-3 transition-all flex items-center justify-center gap-2 focus-visible:ring-2 focus-visible:ring-cyan-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950');
            document.querySelectorAll('.btn.is-active').forEach(el => el.classList.add('bg-cyan-400/20', 'text-cyan-300', 'border-cyan-500/50'));
            document.querySelectorAll('.btn-story').forEach(el => el.className = 'btn-story w-full text-sm bg-slate-800 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed rounded-md py-2.5 px-3 transition-colors focus-visible:ring-2 focus-visible:ring-cyan-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950 text-left font-medium');
            document.querySelectorAll('.fb-input').forEach(el => el.className = 'fb-input w-full bg-slate-800 border border-slate-700 rounded-md p-2 text-sm placeholder-slate-500 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none');

            lucide.createIcons();
        }

        bindEvents() {
            window.addEventListener('resize', () => this.centerRobot());
            
            // Robot Interaction
            this.els.robotWrap.addEventListener('pointerdown', e => this.startDrag(e));
            this.els.robotWrap.addEventListener('pointermove', e => this.onDrag(e));
            this.els.robotWrap.addEventListener('pointerup', () => this.stopDrag());
            this.els.robotWrap.addEventListener('pointercancel', () => this.stopDrag());
            this.els.robotWrap.addEventListener('keydown', e => this.handleKeyboardMove(e));

            // UI Controls
            this.els.scaleRange.addEventListener('input', e => this.applyScale(e.target.value));
            this.els.actionButtons.forEach(btn => btn.addEventListener('click', () => this.handleAction(btn.dataset.action, btn)));
            
            // Panel Controls for Mobile
            this.els.panel.toggle.addEventListener('click', () => this.togglePanel());
            this.els.panel.overlay.addEventListener('click', () => this.togglePanel());

            // Feedback Modal
            this.els.feedback.copy.addEventListener('click', () => this.copyFeedback());
            this.els.feedback.clear.addEventListener('click', () => this.clearFeedback());
        }
        
        // --- UI & THEME ---
        togglePanel() {
            const isOpen = this.els.panel.controls.classList.toggle('-translate-x-full');
            this.els.panel.controls.classList.toggle('translate-x-0', !isOpen);
            this.els.panel.overlay.classList.toggle('opacity-0', isOpen);
            this.els.panel.overlay.classList.toggle('pointer-events-none', isOpen);
        }

        applyScale(v) { document.documentElement.style.setProperty('--robot-scale', v); }
        applyTheme(t) {
            const r = document.documentElement.style;
            r.setProperty('--shell', t.shell); r.setProperty('--line', t.line); r.setProperty('--face', t.face); r.setProperty('--eye', t.eye); r.setProperty('--accent', t.accent); r.setProperty('--accent-light', t.accentLight);
            this.els.batteryGradStops.forEach((s, i) => s.setAttribute('stop-color', i === 0 ? t.accent : t.accentLight));
        }

        // --- ROBOT MOVEMENT ---
        centerRobot() { const stage = document.getElementById('stage'); this.state.robotPos = { x: stage.clientWidth / 2, y: stage.clientHeight / 2 }; this.updateRobotPosition(); }
        updateRobotPosition() { this.els.robotWrap.style.left = `${this.state.robotPos.x}px`; this.els.robotWrap.style.top = `${this.state.robotPos.y}px`; }
        startDrag(e) { this.state.isDragging = true; this.els.robotWrap.classList.add('dragging'); this.els.robotWrap.setPointerCapture(e.pointerId); this.state.dragStart = { x: e.clientX - this.state.robotPos.x, y: e.clientY - this.state.robotPos.y }; }
        onDrag(e) { if (!this.state.isDragging) return; this.state.robotPos.x = e.clientX - this.state.dragStart.x; this.state.robotPos.y = e.clientY - this.state.dragStart.y; this.updateRobotPosition(); }
        stopDrag() { this.state.isDragging = false; this.els.robotWrap.classList.remove('dragging'); }
        handleKeyboardMove(e) { const step = e.shiftKey ? 20 : 5; const actions = { ArrowUp: () => this.state.robotPos.y -= step, ArrowDown: () => this.state.robotPos.y += step, ArrowLeft: () => this.state.robotPos.x -= step, ArrowRight: () => this.state.robotPos.x += step }; if (actions[e.key]) { e.preventDefault(); actions[e.key](); this.updateRobotPosition(); } }

        // --- ACTION HANDLER ---
        handleAction(action, btn) { if (action.startsWith('story') && this.state.isBusy) return; if (action.startsWith('toggle-')) { this.toggleAction(action.replace('toggle-', ''), btn); } else { this[action](btn); } }
        toggleAction(action, btn) {
            const stateMap = { speak: 'is-speaking', nod: 'is-nodding', ears: 'is-wiggling', hover: 'is-hovering' };
            if (stateMap[action]) { const isActive = this.els.robot.classList.toggle(stateMap[action]); btn.classList.toggle('is-active', isActive); }
            else if (action === 'waveLeft' || action === 'waveRight' || action === 'float') { const isActive = this[action](); btn.classList.toggle('is-active', isActive); }
        }
        async setBusy(isBusy) { this.state.isBusy = isBusy; this.els.actionButtons.forEach(b => { if (b.dataset.action.startsWith('story') || isBusy) b.disabled = isBusy; }); }
        
        // --- ROBOT ACTIONS (SIMPLE) ---
        theme() { this.state.currentTheme = (this.state.currentTheme + 1) % this.themes.length; this.applyTheme(this.themes[this.state.currentTheme]); }
        blink() { this.els.eyes.forEach(e => { e.classList.add('is-blinking'); setTimeout(() => e.classList.remove('is-blinking'), 180); }); }
        startBlinkLoop() { const loop = () => { setTimeout(() => { if (!this.state.isBusy) this.blink(); loop(); }, 1200 + Math.random() * 1800); }; loop(); }
        tilt() { this.els.robot.classList.add('is-tilting'); setTimeout(() => this.els.robot.classList.remove('is-tilting'), 620); }
        charge() { this.els.torsoWrap.classList.remove('is-charging'); void this.els.torsoWrap.offsetWidth; this.els.torsoWrap.classList.add('is-charging'); }
        glance(dx, dy) { this.els.pupils.forEach(p => p.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`); }
        resetAll() { ['is-speaking', 'is-nodding', 'is-wiggling', 'is-tilting', 'is-hovering'].forEach(c => this.els.robot.classList.remove(c)); this.els.torsoWrap.classList.remove('is-charging'); this.armReset(); this.glance(0, 0); this.els.actionButtons.forEach(b => b.classList.remove('is-active')); document.querySelector('[data-action="toggle-hover"]').classList.add('is-active'); this.els.robot.classList.add('is-hovering'); this.blink(); }

        // Arm Actions
        waveLeft() { this.state.wave.left = !this.state.wave.left; this.updateAnimLoop(); return this.state.wave.left; }
        waveRight() { this.state.wave.right = !this.state.wave.right; this.updateAnimLoop(); return this.state.wave.right; }
        flare() { if (!this.state.flare.active) { this.state.flare = { ...this.state.flare, active: true, base: this.geometry.size.bulge, peak: this.geometry.size.bulge + 10, start: 0 }; this.updateAnimLoop(); }}
        float() { this.state.float.active = !this.state.float.active; if(this.state.float.active) { this.state.float.base = this.geometry.align.anchorY; } this.updateAnimLoop(); return this.state.float.active; }
        armReset() { this.state.wave.left = this.state.wave.right = this.state.float.active = false; this.updateAnimLoop(); document.querySelectorAll('[data-action^="toggle-wave"], [data-action="toggle-float"]').forEach(b => b.classList.remove('is-active')); }

        // --- STORY MACROS ---
        async storyGreet() { this.setBusy(true); document.querySelector('[data-action="toggle-speak"]').click(); document.querySelector('[data-action="toggle-waveLeft"]').click(); this.glance(-4, 0); await new Promise(r => setTimeout(r, 1200)); this.glance(4, 0); await new Promise(r => setTimeout(r, 1000)); this.glance(0, 0); document.querySelector('[data-action="toggle-waveLeft"]').click(); document.querySelector('[data-action="toggle-speak"]').click(); this.setBusy(false); }
        async storyShy() { this.setBusy(true); this.tilt(); document.querySelector('[data-action="toggle-waveRight"]').click(); this.glance(-3, 2); await this.waitForAnimation(this.els.robot.querySelector('.head'), 'tiltShort'); this.blink(); await new Promise(r => setTimeout(r, 600)); document.querySelector('[data-action="toggle-waveRight"]').click(); this.glance(0, 0); this.setBusy(false); }
        async storyPresent() { this.setBusy(true); this.flare(); this.glance(0, -2); await new Promise(r => setTimeout(r, 1200)); this.glance(0, 0); this.setBusy(false); }
        async storyThink() { this.setBusy(true); document.querySelector('[data-action="toggle-nod"]').click(); document.querySelector('[data-action="toggle-float"]').click(); this.glance(0, 4); await new Promise(r => setTimeout(r, 2200)); this.blink(); document.querySelector('[data-action="toggle-nod"]').click(); document.querySelector('[data-action="toggle-float"]').click(); this.glance(0, 0); this.setBusy(false); }
        async storyCelebrate() { this.setBusy(true); document.querySelector('[data-action="toggle-waveLeft"]').click(); document.querySelector('[data-action="toggle-waveRight"]').click(); this.charge(); this.glance(0, -4); await this.waitForAnimation(document.getElementById('batteryFill'), 'charge'); this.blink(); document.querySelector('[data-action="toggle-waveLeft"]').click(); document.querySelector('[data-action="toggle-waveRight"]').click(); this.glance(0, 0); this.setBusy(false); }
        
        // --- ARM ANIMATION & DRAWING ---
        updateAnimLoop() { const shouldBeRunning = this.state.wave.left || this.state.wave.right || this.state.float.active || this.state.flare.active; if (shouldBeRunning && !this.state.rafId) { this.state.rafId = requestAnimationFrame(t => this.animLoop(t)); } }
        
        animLoop(ts) {
            let { anchorY, inset } = this.geometry.align; let needsRedraw = false;
            
            const axLeftPos = 220 - inset;  // Robot's Left Arm is on the right side of the screen
            const axRightPos = 40 + inset;   // Robot's Right Arm is on the left side of the screen

            if (!this.state.wave.start) this.state.wave.start = ts; const ang = Math.sin(((ts - this.state.wave.start) / this.state.wave.period) * 2 * Math.PI) * this.state.wave.amp;
            if (this.state.float.active) { if (!this.state.float.start) this.state.float.start = ts; anchorY = this.state.float.base + Math.sin(((ts - this.state.float.start) / this.state.float.period) * 2 * Math.PI) * this.state.float.amp; needsRedraw = true; }
            if (this.state.flare.active) { if (!this.state.flare.start) this.state.flare.start = ts; const p = Math.min(1, (ts - this.state.flare.start) / this.state.flare.dur); this.geometry.size.bulge = this.state.flare.base + Math.sin(p * Math.PI) * (this.state.flare.peak - this.state.flare.base); needsRedraw = true; if (p >= 1) { this.geometry.size.bulge = this.state.flare.base; this.state.flare.active = false; } }
            
            // DRAWING FIX: The `side` parameter is swapped to draw the correct shape at each position.
            const wingPath = (side, position) => this.wingAirfoilPath(position, anchorY, this.geometry.size.len, this.geometry.size.bulge, this.geometry.size.tip, this.geometry.size.innerCurve, side);
            
            if (needsRedraw) {
                this.els.svg.wingRight.setAttribute('d', wingPath('left', axRightPos)); // Robot's Right arm bulges left
                this.els.svg.wingLeft.setAttribute('d', wingPath('right', axLeftPos)); // Robot's Left arm bulges right
            }

            document.getElementById('armLeft').setAttribute('transform', `rotate(${this.state.wave.left ? -ang : 0} ${axLeftPos} ${anchorY})`);
            document.getElementById('armRight').setAttribute('transform', `rotate(${this.state.wave.right ? ang : 0} ${axRightPos} ${anchorY})`);

            if (this.state.wave.left || this.state.wave.right || this.state.float.active || this.state.flare.active) { this.state.rafId = requestAnimationFrame(t => this.animLoop(t)); } else { this.state.rafId = null; this.drawArms(); }
        }

        drawArms() {
            const { len, bulge, tip, innerCurve } = this.geometry.size; 
            const { anchorY, inset } = this.geometry.align;
            
            const axLeftPos = 220 - inset;
            const axRightPos = 40 + inset;
            
            // DRAWING FIX: The `side` parameter is swapped to draw the correct shape at each position.
            this.els.svg.wingRight.setAttribute('d', this.wingAirfoilPath(axRightPos, anchorY, len, bulge, tip, innerCurve, 'left')); // Robot's Right arm bulges left
            this.els.svg.wingLeft.setAttribute('d', this.wingAirfoilPath(axLeftPos, anchorY, len, bulge, tip, innerCurve, 'right')); // Robot's Left arm bulges right

            document.getElementById('armRight').setAttribute('transform', `rotate(0 ${axRightPos} ${anchorY})`);
            document.getElementById('armLeft').setAttribute('transform', `rotate(0 ${axLeftPos} ${anchorY})`);
        }

        wingAirfoilPath(ax, ay, len, bulge, tip, innerCurve, side) {
            const topY = ay, botY = ay + len, midY = (topY + botY) / 2, r = tip / 2;
            // The logic here correctly creates a left-bulging or right-bulging shape
            const innerCtrl = side === 'right' ? ax + innerCurve : ax - innerCurve;
            const tipCtrl = side === 'right' ? ax + bulge / 2 : ax - bulge / 2;
            const outerCtrl = side === 'right' ? ax + bulge : ax - bulge;
            return `M ${ax} ${topY} Q ${innerCtrl} ${midY}, ${ax} ${botY} Q ${tipCtrl} ${botY + r}, ${ax} ${botY + tip} Q ${outerCtrl} ${midY}, ${ax} ${topY} Z`;
        }

        // --- FEEDBACK & UTILS ---
        feedback() { this.els.feedbackDialog.showModal(); }
        copyFeedback() { const payload = { title: this.els.feedback.title.value.trim(), general: this.els.feedback.general.value.trim(), timestamp: new Date().toISOString() }; navigator.clipboard.writeText(JSON.stringify(payload, null, 2)); this.els.feedback.status.textContent = 'Copied to clipboard!'; setTimeout(() => this.els.feedback.status.textContent = '', 2000); }
        clearFeedback() { this.els.feedback.title.value = ''; this.els.feedback.general.value = ''; this.els.feedback.status.textContent = 'Form cleared.'; setTimeout(() => this.els.feedback.status.textContent = '', 2000); }
        waitForAnimation(element, animationName) { return new Promise(resolve => { const onAnimationEnd = (event) => { if (event.animationName === animationName) { element.removeEventListener('animationend', onAnimationEnd); resolve(); } }; element.addEventListener('animationend', onAnimationEnd); }); }
    }
    document.addEventListener('DOMContentLoaded', () => new RobotController());
    </script>
  </body>
</html>

